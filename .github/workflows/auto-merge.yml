# Auto-merge workflow for dependency update PRs
# Only merges if tests pass and PR meets security criteria
# Requires manual approval if tests fail or PR has major updates

name: Auto Merge Dependencies

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
    branches:
      - main
      - master

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    name: Auto Merge Check
    runs-on: ubuntu-latest
    if: |
      contains(github.event.pull_request.labels.*.name, 'dependencies') ||
      contains(github.event.pull_request.labels.*.name, 'automated')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test
        continue-on-error: false

      - name: Check for major version updates
        id: check-major
        run: |
          # Extract version changes from PR files
          git diff origin/${{ github.base_ref }}...HEAD -- package.json > diff.txt || true
          
          # Check if any major version updates exist (simplified check)
          if grep -qE '"[^"]+":\s*"\^?[0-9]+\.' diff.txt; then
            echo "has_major=true" >> $GITHUB_OUTPUT
          else
            echo "has_major=false" >> $GITHUB_OUTPUT
          fi
          
          # Check if PR title contains "major" or "breaking"
          if echo "${{ github.event.pull_request.title }}" | grep -qiE "(major|breaking|v[0-9]+)"; then
            echo "has_major=true" >> $GITHUB_OUTPUT
          fi

      - name: Check PR approval status
        id: check-approval
        uses: actions/github-script@v7
        with:
          script: |
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const approved = reviews.some(r => r.state === 'APPROVED');
            const hasMajor = '${{ steps.check-major.outputs.has_major }}' === 'true';
            
            // Require approval for major updates
            if (hasMajor && !approved) {
              core.setOutput('can_merge', 'false');
              core.setOutput('reason', 'Major version update requires manual approval');
            } else if (!approved) {
              core.setOutput('can_merge', 'false');
              core.setOutput('reason', 'Waiting for approval');
            } else {
              core.setOutput('can_merge', 'true');
              core.setOutput('reason', 'Ready to merge');
            }

      - name: Auto-merge PR
        if: |
          steps.check-approval.outputs.can_merge == 'true' &&
          steps.check-major.outputs.has_major == 'false'
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.AUTO_MERGE_TOKEN || secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash
          merge-commit-message: 'chore(deps): auto-merge dependency updates'

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const canMerge = '${{ steps.check-approval.outputs.can_merge }}' === 'true';
            const hasMajor = '${{ steps.check-major.outputs.has_major }}' === 'true';
            const reason = '${{ steps.check-approval.outputs.reason }}';
            
            let message = '';
            if (canMerge && !hasMajor) {
              message = '✅ **Auto-merge**: Tests passed! This PR will be merged automatically.';
            } else if (hasMajor) {
              message = '⚠️ **Manual Review Required**: This PR contains major version updates. Please review carefully before merging.';
            } else {
              message = `⏳ **Status**: ${reason}`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
